version: '3.8'

services:
  mermaid-mcp:
    build: .
    image: mermaid-mcp:latest
    container_name: mermaid-mcp
    ports:
      # SSE endpoint for MCP communication
      - "8000:8000"
      # CDN proxy for artifact downloads
      - "3001:3001"
    volumes:
      # Mount local directory for artifact storage
      # This enables file persistence across container restarts
      - ${HOST_STORAGE_PATH:-./data/artifacts}:/app/data/artifacts
    environment:
      # Storage Backend Configuration
      # Options: 'auto' (default), 'local', 's3'
      # - auto: Use S3 if credentials present, otherwise local storage
      # - local: Always use local filesystem storage
      # - s3: Always use S3 storage (requires S3 credentials)
      - STORAGE_TYPE=${STORAGE_TYPE:-auto}
      
      # Local Storage Configuration (used when STORAGE_TYPE=local or auto without S3)
      # Container path where artifacts are stored
      - CONTAINER_STORAGE_PATH=/app/data/artifacts
      # Host path for file:// URL generation (should match volume mount)
      - HOST_STORAGE_PATH=${HOST_STORAGE_PATH:-./data/artifacts}
      # URL scheme for local artifacts: 'file' (default) or 'http'
      # - file: Returns file:// URLs pointing to host filesystem
      # - http: Returns http:// URLs via CDN proxy
      - LOCAL_URL_SCHEME=${LOCAL_URL_SCHEME:-file}
      
      # CDN Proxy Configuration (used when LOCAL_URL_SCHEME=http)
      - CDN_HOST=${CDN_HOST:-localhost}
      - CDN_PORT=${CDN_PORT:-3001}
      
      # S3 Storage Configuration (optional, used when STORAGE_TYPE=s3 or auto with credentials)
      # MinIO endpoint (for local testing) or AWS S3 endpoint
      - MERMAID_S3_ENDPOINT=${MERMAID_S3_ENDPOINT:-}
      # S3 bucket name for artifact storage
      - MERMAID_S3_BUCKET=${MERMAID_S3_BUCKET:-}
      # AWS credentials (use AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY or these)
      - MERMAID_S3_ACCESS_KEY=${MERMAID_S3_ACCESS_KEY:-}
      - MERMAID_S3_SECRET_KEY=${MERMAID_S3_SECRET_KEY:-}
      # AWS region (defaults to us-east-1)
      - AWS_REGION=${AWS_REGION:-us-east-1}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Optional: MinIO for local S3-compatible storage testing
  minio:
    image: minio/minio:latest
    container_name: mermaid-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    restart: unless-stopped
    profiles:
      - with-s3

volumes:
  minio-data:
